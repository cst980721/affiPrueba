trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureServiceConnection: 'azure-connection'
  resourceGroupName: 'AffiGrupoDeRecursos'
  storageAccountName: 'mistorageaccount123'
  containerName: 'mi-container'
  location: 'East US'

steps:
  - checkout: self

  - task: TerraformInstaller@1
    inputs:
      terraformVersion: 'latest'
    displayName: 'Instalar Terraform'

  - script: |
      terraform init
      terraform apply -auto-approve
    workingDirectory: infra
    displayName: 'Desplegar Infraestructura con Terraform'

  - script: zip -r app.zip .
    displayName: 'Empaquetar aplicaci√≥n'

  - task: AzureCLI@2
    inputs:
      azureSubscription: $(azureServiceConnection)
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az storage blob upload --account-name $(storageAccountName) \
          --container-name $(containerName) \
          --name app.zip \
          --file app.zip \
          --auth-mode login
    displayName: 'Subir artefacto a Blob Storage'
